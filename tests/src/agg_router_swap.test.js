import 'core-js/stable';
import 'regenerator-runtime/runtime';
import { waitForAppScreen, zemu, nano_models, txFromEtherscan } from './test.fixture';

nano_models.forEach(function (model) {
  test(
    '[Nano ' + model.letter + '] Agg router swap',
    zemu(model, async (sim, eth) => {
      // The rawTx of the tx up above is accessible through: https://etherscan.io/getRawTx?tx=0x49f681722f63294f4b238c7739fe57cbd18f34575d254e9c01d7b4f7355f226d
      const serializedTx = txFromEtherscan(
        '0x02f90221011c85037e11d60085037e11d60083031714941aaad07998466cd3eb8140827dddb37570be1e63872386f26fc10000b901ab97b3c27300000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000000000000000000000000000002386f26fc100000000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000000000000000000000000000a710564511260b9f00000000000000000000000000000000000000000000000000000000000000c80502b1c50000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002386f26fc10000000000000000000000000000000000000000000000000000a710564511260b9f0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000180000000000000003b74a4607515be43d16f871588adc135d58a9c30a71eb34fcfee7c08000000000000000000000000000000000000000000000000deb8d863773683c001a0073685c000436501453247286ae8701e89a346aeeafb8b7120264fefe13c51c0a03722d700598c833d3ef174763bbd7a519dea3f328b774dc851b8eefe64e93083'
      );

      const tx = eth.signTransaction("44'/60'/0'/0", serializedTx);

      const right_clicks = model.letter === 'S' ? 7 : 5;

      // Wait for the application to actually load and parse the transaction
      await waitForAppScreen(sim);
      // Navigate the display by pressing the right button `right_clicks` times, then pressing both buttons to accept the transaction.
      await sim.navigateAndCompareSnapshots('.', model.name + 'agg-router-swap', [right_clicks, 0]);

      await tx;
    })
  );
});
